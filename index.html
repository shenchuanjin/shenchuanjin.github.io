<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>语音通话示例</title>
</head>
<body>
    <h1>语音通话示例</h1>

    <!-- 按钮来启动和停止通话 -->
    <button id="start-call">开始通话</button>
    <button id="end-call" disabled>结束通话</button>

    <h2>语音输入:</h2>
    <audio id="audio" controls autoplay></audio>

    <script>
        let localStream;
        let peerConnection;
        const startCallButton = document.getElementById("start-call");
        const endCallButton = document.getElementById("end-call");
        const audioElement = document.getElementById("audio");

        // 获取用户的音频流
        async function startUserMedia() {
            try {
                localStream = await navigator.mediaDevices.getUserMedia({ audio: true });
                console.log("音频流获取成功",localStream);
                startCallButton.disabled = true;
                endCallButton.disabled = false;
            } catch (err) {
                console.error("获取音频流失败", err);
            }
        }

        // 设置Peer Connection并建立音频通话
        function createPeerConnection() {
            peerConnection = new RTCPeerConnection();
          console.log('fsfsfs')
            // 将本地音频流添加到连接中
            localStream.getTracks().forEach(track => {
                peerConnection.addTrack(track, localStream);
            });

            // 当接收到远端音频流时，将其设置为audio标签的源
            peerConnection.ontrack = function(event) {
                audioElement.srcObject = event.streams[0];
            };

            // 处理ICE候选
            peerConnection.onicecandidate = function(event) {
                if (event.candidate) {
                    console.log("发现ICE候选:", event.candidate);
                    // 这里通常会通过信令服务器发送ICE候选
                }
            };
        }

        // 启动通话
        startCallButton.addEventListener("click", async () => {
            await startUserMedia();
            createPeerConnection();

            // 这里你应该与另一个用户交换SDP信息，并建立连接
            // 这通常涉及通过WebSocket或其他信令协议来交换offer/answer等信息
        });

        // 结束通话
        endCallButton.addEventListener("click", () => {
            if (peerConnection) {
                peerConnection.close();
                peerConnection = null;
            }
            if (localStream) {
                localStream.getTracks().forEach(track => track.stop());
                localStream = null;
            }
            startCallButton.disabled = false;
            endCallButton.disabled = true;
            audioElement.srcObject = null;
        });
    </script>
</body>
</html>
